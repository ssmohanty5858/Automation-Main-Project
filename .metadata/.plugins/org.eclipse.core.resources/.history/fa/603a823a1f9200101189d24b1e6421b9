package util;

import org.testng.Reporter;

import java.io.OutputStream;
import java.io.PrintStream;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;

public final class ReporterConsoleBridge {
  private ReporterConsoleBridge() {}

  public static void install() {
    final PrintStream originalOut = System.out;

    OutputStream tee = new OutputStream() {
      private final StringBuilder buf = new StringBuilder();
      @Override public void write(int b) {
        char c = (char) b;
        buf.append(c);
        if (c == '\n') {
          String line = buf.toString();
          originalOut.print(line);                        // keep console
          Reporter.log(escape(line), false);              // into TestNG logs (picked by our reporter)
          buf.setLength(0);
        }
      }
      private String escape(String s) {
        return s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;");
      }
    };

    System.setOut(new PrintStream(tee, true, StandardCharsets.UTF_8));
  }
  public static void logArtifact(String label, Path file) {
      if (file == null) return;
      Reporter.log("ARTIFACT::" + (label == null ? "" : label) + "::" + file.toAbsolutePath());
  }
}
