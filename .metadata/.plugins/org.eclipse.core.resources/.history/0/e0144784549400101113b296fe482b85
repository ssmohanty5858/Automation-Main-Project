package util;

import org.testng.IReporter;
import org.testng.ISuite;
import org.testng.ISuiteResult;
import org.testng.ITestContext;
import org.testng.ITestResult;
import org.testng.xml.XmlSuite;

import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;
import java.util.*;

public class EmailableReportWithFailures implements IReporter {

    @Override
    public void generateReport(List<XmlSuite> xmlSuites, List<ISuite> suites, String outputDirectory) {
        try (BufferedWriter w = new BufferedWriter(new FileWriter(outputDirectory + "/failures-report.html"))) {
            writeHeader(w);

            for (ISuite suite : suites) {
                w.write("<h2>Suite: " + esc(suite.getName()) + "</h2>");

                Map<ITestContext, List<ITestResult>> failuresGrouped = new LinkedHashMap<>();

                for (ISuiteResult result : suite.getResults().values()) {
                    ITestContext ctx = result.getTestContext();
                    Set<ITestResult> failedTests = ctx.getFailedTests().getAllResults();
                    if (!failedTests.isEmpty()) {
                        failuresGrouped.put(ctx, new ArrayList<>(failedTests));
                    }
                }

                for (Map.Entry<ITestContext, List<ITestResult>> entry : failuresGrouped.entrySet()) {
                    ITestContext ctx = entry.getKey();
                    List<ITestResult> failedResults = entry.getValue();

                    writeContextTable(w, ctx);
                    writeSummaryCards(w, ctx);
                    writeFailureTable(w, failedResults);
                }
            }

            writeFooter(w);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void writeHeader(BufferedWriter w) throws IOException {
        w.write("<html><head><title>Automation Test Failure Report</title>");
        w.write("<meta charset='utf-8' />");
        w.write("<style>");
        w.write("body{font-family:Segoe UI,system-ui,Arial,sans-serif;margin:18px;color:#0f172a;background:#fafafa;}");
        w.write(".kpi{display:grid;grid-template-columns:repeat(8,1fr);gap:12px;margin:10px 0 18px;}");
        w.write(".card{background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:12px;text-align:center;}");
        w.write(".num{font-weight:700;font-size:20px;}");
        w.write(".bad-b{background:#fef2f2;border-color:#fecaca;}");
        w.write("table{border-collapse:collapse;width:100%;background:#fff;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.04);}");
        w.write("th,td{border:1px solid #e6e6e6;padding:10px;vertical-align:top;font-size:14px;}");
        w.write("th{background:#f4f6f8;text-transform:uppercase;font-size:12px;letter-spacing:.04em;color:#334155;}");
        w.write(".muted{color:#64748b;}");
        w.write(".collapsible{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:6px;padding:6px;cursor:pointer;}");
        w.write(".collapsible:after{content:'â–¼';font-size:10px;float:right;}");
        w.write(".content{padding:8px 10px;border-top:1px dashed #e5e7eb;display:none;}");
        w.write("tr:nth-child(even){background:#f9f9f9;}");
        w.write("</style>");
        w.write("<script>function toggle(id){var el=document.getElementById(id);el.style.display=el.style.display=='block'?'none':'block';}</script>");
        w.write("</head><body>");
        w.write("<h1>Automation Test Failure Report</h1>");
        w.write("<div class='muted'>Generated: " + new Date() + "</div>");
    }

    private void writeFooter(BufferedWriter w) throws IOException {
        w.write("</body></html>");
    }

    private void writeContextTable(BufferedWriter w, ITestContext ctx) throws IOException {
        w.write("<h3>Test: " + esc(ctx.getName()) + "</h3>");
    }

    private void writeSummaryCards(BufferedWriter w, ITestContext ctx) throws IOException {
        int total = ctx.getAllTestMethods().length;
        int passed = ctx.getPassedTests().size();
        int failed = ctx.getFailedTests().size();
        int skipped = ctx.getSkippedTests().size();
        long duration = ctx.getEndDate().getTime() - ctx.getStartDate().getTime();

        w.write("<div class='kpi'>");
        w.write("<div class='card num'>Total<br>" + total + "</div>");
        w.write("<div class='card num' style='background:#ecfdf5; border-color:#a7f3d0;'>Passed<br>" + passed + "</div>");
        w.write("<div class='card num bad-b'>Failed<br>" + failed + "</div>");
        w.write("<div class='card num'>Skipped<br>" + skipped + "</div>");
        w.write("<div class='card num'>Duration (ms)<br>" + duration + "</div>");
        w.write("</div>");
    }

    private void writeFailureTable(BufferedWriter w, List<ITestResult> failedResults) throws IOException {
        w.write("<table><thead><tr>");
        w.write("<th>#</th><th>Class</th><th>Method</th><th>Status</th><th>Start</th>");
        w.write("<th>End</th><th>Duration (ms)</th><th>Logs</th><th>Error</th>");
        w.write("</tr></thead><tbody>");

        int idx = 1;
        for (ITestResult r : failedResults) {
            String logsId = "logs" + idx;
            String errorId = "err" + idx;
            w.write("<tr>");
            w.write("<td>" + idx + "</td>");
            w.write("<td>" + esc(r.getTestClass().getName()) + "</td>");
            w.write("<td>" + esc(r.getMethod().getMethodName()) + "</td>");
            w.write("<td style='color:red;font-weight:bold;'>Failed</td>");
            w.write("<td>" + new Date(r.getStartMillis()) + "</td>");
            w.write("<td>" + new Date(r.getEndMillis()) + "</td>");
            w.write("<td>" + (r.getEndMillis() - r.getStartMillis()) + "</td>");
            w.write("<td><div class='collapsible' onclick='toggle(\"" + logsId + "\")'>Logs(click to expand/collapse)</div>");
            w.write("<div class='content' id='" + logsId + "'>" + esc(getLogs(r)) + "</div></td>");
            w.write("<td><div class='collapsible bad-b' onclick='toggle(\"" + errorId + "\")'>View error (click to expand/collapse)</div>");
            w.write("<div class='content' id='" + errorId + "'>" + esc(getErrorMessage(r)) + "</div></td>");
            w.write("</tr>");
            idx++;
        }
        w.write("</tbody></table>");
    }

    private String esc(String s) {
        if (s == null) return "";
        return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }

    private String getLogs(ITestResult r) {
        // Customize to fetch logs similar to your main class
        return "Logs not implemented";
    }

    private String getErrorMessage(ITestResult r) {
        Throwable t = r.getThrowable();
        if (t == null) return "No error.";
        return esc(t.toString() + "<br/>" + t.getMessage());
    }
}
